<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material 3 Website Builder</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .builder-container {
            display: flex;
            height: 100vh;
        }

        /* Component Panel */
        .component-panel {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e0e0e0;
            padding: 16px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            color: #1976d2;
        }

        .component-category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 14px;
            font-weight: 500;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .component-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: grab;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .component-item:hover {
            background: #e3f2fd;
            border-color: #1976d2;
            transform: translateY(-1px);
        }

        .component-item:active {
            cursor: grabbing;
        }

        .component-item .material-icons {
            margin-right: 12px;
            color: #1976d2;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .canvas-toolbar {
            height: 60px;
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 16px;
            overflow-x: auto;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #e3f2fd;
            color: #1976d2;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-btn:hover {
            background: #1976d2;
            color: white;
        }

        .canvas {
            flex: 1;
            background: #ffffff;
            margin: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow-y: auto;
            min-height: calc(100vh - 120px);
        }

        .canvas-content {
            min-height: 100%;
            padding: 20px;
        }
        
        #canvasContent.is-empty .drop-zone {
            display: flex;
        }

        .drop-zone {
            min-height: 200px;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 16px;
            transition: all 0.2s ease;
            display: none;
            margin-bottom: 16px;
        }

        .drop-zone.drag-over {
            border-color: #1976d2;
            background: #f3f8ff;
            color: #1976d2;
        }

        /* Properties Panel */
        .properties-panel {
            width: 320px;
            background: #ffffff;
            border-left: 1px solid #e0e0e0;
            padding: 16px;
            overflow-y: auto;
        }

        /* Material 3 Components */
        .m3-button {
            padding: 10px 24px;
            border: none;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 8px;
        }

        .m3-button.filled {
            background: #1976d2;
            color: white;
        }

        .m3-button.outlined {
            background: transparent;
            color: #1976d2;
            border: 1px solid #1976d2;
        }

        .m3-button.text {
            background: transparent;
            color: #1976d2;
        }

        .m3-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            padding: 16px;
            margin: 16px 0;
            transition: all 0.2s ease;
        }

        .m3-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.16);
        }

        .m3-text-field {
            width: 100%;
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 16px;
            margin: 8px 0;
            outline: none;
            transition: all 0.2s ease;
        }

        .m3-text-field:focus {
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }

        .m3-chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: #e0e0e0;
            border-radius: 16px;
            font-size: 14px;
            margin: 4px;
        }

        .m3-fab {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: #1976d2;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        }

        .m3-top-app-bar {
            height: 64px;
            background: #1976d2;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .m3-navigation-rail {
            width: 80px;
            background: #f5f5f5;
            padding: 12px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .nav-item {
            width: 56px;
            height: 32px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: #e3f2fd;
        }

        .dropped-component {
            position: relative;
            margin: 8px 0;
            min-height: 40px;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.2s ease, background-color 0.2s ease; /* Exclude opacity */
            cursor: pointer;
        }
        .dropped-component.dragging {
            opacity: 0.4;
        }

        .drop-placeholder {
            height: 4px;
            background-color: #1976d2;
            border-radius: 2px;
            margin: 12px 0;
            transition: all 0.2s ease;
        }

        .dropped-component:hover {
            border-color: #a9cff8;
        }

        .dropped-component.selected {
            border-color: #1976d2;
            background: rgba(25, 118, 210, 0.05);
        }

        .component-controls {
            position: absolute;
            top: -28px;
            right: -2px;
            background: #1976d2;
            border-radius: 4px;
            padding: 4px;
            display: none;
            gap: 4px;
            z-index: 10;
        }

        .dropped-component.selected .component-controls {
            display: flex;
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .drag-handle {
            cursor: move;
        }

        .property-group {
            margin-bottom: 16px;
        }

        .property-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .property-input, .property-select, .property-textarea, .property-number {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .property-select {
            cursor: pointer;
        }

        .property-color {
            width: 100%;
            height: 40px;
            padding: 0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
        }

        .property-range {
            width: 100%;
            margin: 8px 0;
        }

        .range-display {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 4px;
        }

        .property-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .export-code {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .export-modal {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .export-modal textarea {
            width: 100%;
            height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 16px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="builder-container">
        <!-- Component Panel -->
        <div class="component-panel">
            <h2 class="panel-title">Components</h2>
            
            <div class="component-category">
                <div class="category-title">Actions</div>
                <div class="component-item" draggable="true" data-component="button">
                    <span class="material-icons">smart_button</span>
                    Button
                </div>
                <div class="component-item" draggable="true" data-component="fab">
                    <span class="material-icons">add</span>
                    FAB
                </div>
            </div>

            <div class="component-category">
                <div class="category-title">Input</div>
                <div class="component-item" draggable="true" data-component="textfield">
                    <span class="material-icons">input</span>
                    Text Field
                </div>
                <div class="component-item" draggable="true" data-component="chip">
                    <span class="material-icons">label</span>
                    Chip
                </div>
            </div>

            <div class="component-category">
                <div class="category-title">Layout</div>
                <div class="component-item" draggable="true" data-component="card">
                    <span class="material-icons">crop_landscape</span>
                    Card
                </div>
                <div class="component-item" draggable="true" data-component="appbar">
                    <span class="material-icons">web_asset</span>
                    App Bar
                </div>
                <div class="component-item" draggable="true" data-component="navigation">
                    <span class="material-icons">menu</span>
                    Navigation
                </div>
            </div>

            <div class="component-category">
                <div class="category-title">Content</div>
                <div class="component-item" draggable="true" data-component="text">
                    <span class="material-icons">text_fields</span>
                    Text
                </div>
                <div class="component-item" draggable="true" data-component="image">
                    <span class="material-icons">image</span>
                    Image
                </div>
                <div class="component-item" draggable="true" data-component="divider">
                    <span class="material-icons">horizontal_rule</span>
                    Divider
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-area">
            <div class="canvas-toolbar">
                <button class="toolbar-btn" id="loadBtn">
                    <span class="material-icons">folder_open</span>
                    Load
                </button>
                 <button class="toolbar-btn" id="saveBtn">
                    <span class="material-icons">save</span>
                    Save
                </button>
                <button class="toolbar-btn" id="clearBtn">
                    <span class="material-icons">clear</span>
                    Clear
                </button>
                <button class="toolbar-btn" id="previewBtn">
                    <span class="material-icons">preview</span>
                    Preview
                </button>
                <button class="toolbar-btn" id="exportBtn">
                    <span class="material-icons">code</span>
                    Export Code
                </button>
            </div>
            
            <div class="canvas" id="canvas">
                <div class="canvas-content is-empty" id="canvasContent">
                    <div class="drop-zone" id="dropZone">
                        Drop components here to start building your website
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties-panel">
            <h2 class="panel-title">Properties</h2>
            <div id="propertiesContent">
                <p style="color: #666; text-align: center; margin-top: 40px;">
                    Select a component to edit its properties
                </p>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="export-code" id="exportModal">
        <div class="export-modal">
            <h3 style="margin-bottom: 16px;">Export HTML Code</h3>
            <textarea id="exportedCode" readonly></textarea>
            <div style="margin-top: 16px; text-align: right;">
                <button class="m3-button outlined" id="copyCodeBtn">Copy Code</button>
                <button class="m3-button filled" id="closeExportBtn">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let selectedComponentId = null;
            let componentCounter = 0;
            let websiteComponents = []; // Array to store component data objects

            const componentItems = document.querySelectorAll('.component-item');
            const canvasContent = document.getElementById('canvasContent');
            const propertiesContent = document.getElementById('propertiesContent');
            const exportModal = document.getElementById('exportModal');

            // --- COMPONENT TEMPLATES ---
            const componentTemplates = {
                button: {
                    html: (props) => `<button class="m3-button">${props.text.value}</button>`,
                    properties: { text: { value: 'Button Text', type: 'text', label: 'Button Text' }, style: { value: 'filled', type: 'select', label: 'Button Style', options: ['filled', 'outlined', 'text'] }, backgroundColor: { value: '#1976d2', type: 'color', label: 'Background Color' }, textColor: { value: '#ffffff', type: 'color', label: 'Text Color' }, borderRadius: { value: 20, type: 'range', label: 'Border Radius', min: 0, max: 50, unit: 'px' }, fontSize: { value: 14, type: 'select', label: 'Font Size', options: [12, 14, 16, 18, 20, 24], unit: 'px' }, fontWeight: { value: 500, type: 'select', label: 'Font Weight', options: [300, 400, 500, 700] }, padding: { value: '10px 24px', type: 'text', label: 'Padding (e.g., 10px 24px)'}, alignment: { value: 'flex-start', type: 'select', label: 'Alignment', options: {'Left': 'flex-start', 'Center': 'center', 'Right': 'flex-end'} } }
                },
                fab: {
                    html: (props) => `<button class="m3-fab"><span class="material-icons">${props.icon.value}</span></button>`,
                    properties: { icon: { value: 'add', type: 'select', label: 'Icon', options: ['add', 'edit', 'favorite', 'home', 'search', 'settings', 'star', 'close', 'menu', 'arrow_back', 'share', 'bookmark', 'check', 'delete'] }, backgroundColor: { value: '#1976d2', type: 'color', label: 'Background Color' }, iconColor: { value: '#ffffff', type: 'color', label: 'Icon Color' }, size: { value: 56, type: 'select', label: 'Size', options: [40, 48, 56, 64], unit: 'px' }, borderRadius: { value: 16, type: 'range', label: 'Border Radius', min: 0, max: 28, unit: 'px' }, elevation: { value: '0 3px 5px rgba(0,0,0,0.2)', type: 'select', label: 'Shadow', options: {'None': 'none', 'Low': '0 1px 3px rgba(0,0,0,0.12)', 'Medium': '0 3px 5px rgba(0,0,0,0.2)', 'High': '0 6px 10px rgba(0,0,0,0.25)'} } }
                },
                textfield: {
                    html: (props) => `<input class="m3-text-field" type="${props.inputType.value}" placeholder="${props.placeholder.value}" />`,
                    properties: { placeholder: { value: 'Enter text here', type: 'text', label: 'Placeholder Text' }, inputType: { value: 'text', type: 'select', label: 'Input Type', options: ['text', 'email', 'password', 'number', 'tel', 'url', 'search'] }, width: { value: '100%', type: 'select', label: 'Width', options: ['100%', '75%', '50%', '25%'] }, fontSize: { value: 16, type: 'select', label: 'Font Size', options: [12, 14, 16, 18, 20], unit: 'px' }, borderColor: { value: '#e0e0e0', type: 'color', label: 'Border Color' }, backgroundColor: { value: '#ffffff', type: 'color', label: 'Background Color' }, textColor: { value: '#000000', type: 'color', label: 'Text Color' } }
                },
                chip: {
                    html: (props) => `<span class="m3-chip">${props.text.value}</span>`,
                    properties: { text: { value: 'Chip Text', type: 'text', label: 'Chip Text' }, backgroundColor: { value: '#e0e0e0', type: 'color', label: 'Background Color' }, textColor: { value: '#000000', type: 'color', label: 'Text Color' }, borderRadius: { value: 16, type: 'range', label: 'Border Radius', min: 0, max: 25, unit: 'px' }, fontSize: { value: 14, type: 'select', label: 'Font Size', options: [12, 14, 16], unit: 'px' }, }
                },
                card: {
                    html: (props) => `<div class="m3-card"><h3>${props.title.value}</h3><p>${props.content.value}</p></div>`,
                    properties: { title: { value: 'Card Title', type: 'text', label: 'Card Title' }, content: { value: 'Card content goes here...', type: 'textarea', label: 'Card Content' }, backgroundColor: { value: '#ffffff', type: 'color', label: 'Background Color' }, titleColor: { value: '#000000', type: 'color', label: 'Title Color' }, contentColor: { value: '#666666', type: 'color', label: 'Content Color' }, elevation: { value: '0 1px 3px rgba(0,0,0,0.12)', type: 'select', label: 'Elevation', options: {'None': 'none', 'Low': '0 1px 3px rgba(0,0,0,0.12)', 'Medium': '0 4px 8px rgba(0,0,0,0.16)', 'High': '0 8px 16px rgba(0,0,0,0.2)'} }, borderRadius: { value: 12, type: 'range', label: 'Border Radius', min: 0, max: 30, unit: 'px' }, padding: { value: 16, type: 'select', label: 'Padding', options: [8, 12, 16, 20, 24, 32], unit: 'px' }, width: { value: '100%', type: 'select', label: 'Width', options: ['100%', '75%', '50%', '25%'] } }
                },
                text: {
                    html: (props) => `<div style="padding: 8px 0;">${props.content.value}</div>`,
                    properties: { content: { value: 'Sample text content. Edit this in the properties panel.', type: 'textarea', label: 'Text Content (HTML allowed)' }, fontSize: { value: 16, type: 'select', label: 'Font Size', options: [10, 12, 14, 16, 18, 20, 24, 28, 32], unit: 'px' }, textColor: { value: '#333333', type: 'color', label: 'Text Color' }, fontWeight: { value: 'normal', type: 'select', label: 'Font Weight', options: ['300', 'normal', '500', '700', 'bold'] }, textAlign: { value: 'left', type: 'select', label: 'Text Alignment', options: ['left', 'center', 'right', 'justify'] }, lineHeight: { value: 1.5, type: 'select', label: 'Line Height', options: [1, 1.2, 1.5, 1.8, 2] }, }
                },
                image: {
                    html: (props) => `<img src="${props.src.value}" alt="${props.alt.value}" />`,
                    properties: { src: { value: 'https://via.placeholder.com/300x200', type: 'text', label: 'Image URL' }, alt: { value: 'Placeholder', type: 'text', label: 'Alt Text' }, width: { value: '100%', type: 'select', label: 'Width', options: ['25%', '50%', '75%', '100%', 'auto'] }, height: { value: 'auto', type: 'text', label: 'Height (auto, 200px, etc)' }, borderRadius: { value: 8, type: 'range', label: 'Border Radius', min: 0, max: 50, unit: 'px' }, objectFit: { value: 'cover', type: 'select', label: 'Image Fit', options: ['cover', 'contain', 'fill', 'scale-down', 'none'] }, alignment: { value: 'flex-start', type: 'select', label: 'Alignment', options: {'Left': 'flex-start', 'Center': 'center', 'Right': 'flex-end'} } }
                },
                divider: {
                    html: (props) => `<hr />`,
                    properties: { color: { value: '#e0e0e0', type: 'color', label: 'Color' }, thickness: { value: 1, type: 'select', label: 'Thickness', options: [1, 2, 3, 4, 5], unit: 'px' }, margin: { value: 16, type: 'select', label: 'Vertical Margin', options: [0, 8, 12, 16, 20, 24, 32], unit: 'px' }, width: { value: '100%', type: 'select', label: 'Width', options: ['25%', '50%', '75%', '100%'] } }
                },
                appbar: {
                    html: (props) => `<div class="m3-top-app-bar"><h1>${props.title.value}</h1></div>`,
                    properties: { title: { value: 'App Title', type: 'text', label: 'App Title' }, backgroundColor: { value: '#1976d2', type: 'color', label: 'Background Color' }, textColor: { value: '#ffffff', type: 'color', label: 'Text Color' }, height: { value: 64, type: 'select', label: 'Height', options: [48, 56, 64, 72, 80], unit: 'px' }, fontSize: { value: 20, type: 'select', label: 'Title Size', options: [16, 18, 20, 22, 24], unit: 'px' }, elevation: { value: '0 2px 4px rgba(0,0,0,0.1)', type: 'select', label: 'Shadow', options: {'None': 'none', 'Low': '0 2px 4px rgba(0,0,0,0.1)', 'Medium': '0 4px 5px rgba(0,0,0,0.15)', 'High': '0 8px 10px rgba(0,0,0,0.2)'} } }
                },
                navigation: {
                    html: (props) => `<div class="m3-navigation-rail">${props.items.value.split(',').map(item => `<div class="nav-item"><span class="material-icons">${item.trim()}</span></div>`).join('')}</div>`,
                    properties: { items: { value: 'home, search, favorite', type: 'text', label: 'Icons (comma-separated)' }, backgroundColor: { value: '#f5f5f5', type: 'color', label: 'Background Color' }, iconColor: { value: '#666666', type: 'color', label: 'Icon Color' }, activeColor: { value: '#1976d2', type: 'color', label: 'Active/Hover Color' }, width: { value: 80, type: 'select', label: 'Width', options: [60, 70, 80, 90, 100], unit: 'px' }, }
                },
            };

            // --- DRAG & DROP LOGIC ---
            // Drag from component panel
            componentItems.forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', item.dataset.component);
                });
            });

            // Universal dragover for the canvas content area
            canvasContent.addEventListener('dragover', e => {
                e.preventDefault();
                const draggingComponent = document.querySelector('.dragging');
                if (draggingComponent) { // If reordering
                    const placeholder = document.querySelector('.drop-placeholder');
                    const afterElement = getDragAfterElement(canvasContent, e.clientY);
                    if (afterElement == null) {
                        canvasContent.appendChild(placeholder);
                    } else {
                        canvasContent.insertBefore(placeholder, afterElement);
                    }
                } else { // If dragging a new component from the panel
                    const dropZone = document.getElementById('dropZone');
                    if (dropZone) dropZone.classList.add('drag-over');
                }
            });

            // Universal dragleave for the canvas content area
            canvasContent.addEventListener('dragleave', () => {
                const dropZone = document.getElementById('dropZone');
                if (dropZone) dropZone.classList.remove('drag-over');
            });

            // Universal drop for the canvas content area
            canvasContent.addEventListener('drop', e => {
                e.preventDefault();
                const newComponentType = e.dataTransfer.getData('text/plain');
                const movedComponentId = e.dataTransfer.getData('text/component-id');
                
                // If we were reordering an existing component
                if (movedComponentId) {
                    const movedElement = document.getElementById(movedComponentId);
                    const placeholder = document.querySelector('.drop-placeholder');
                    if (placeholder) {
                        // Insert the moved element before the placeholder
                        placeholder.parentNode.insertBefore(movedElement, placeholder);
                    }
                    updateDataArrayOrder(); // Sync the data array with the new DOM order
                } 
                // If we were dropping a new component from the panel
                else if (newComponentType && componentTemplates[newComponentType]) {
                    const dropZone = document.getElementById('dropZone');
                    if (dropZone) dropZone.classList.remove('drag-over');
                    addComponentToCanvas(newComponentType);
                }

                // Cleanup after any drag operation
                const placeholder = document.querySelector('.drop-placeholder');
                if (placeholder) placeholder.remove();
                
                const draggingEl = document.querySelector('.dragging');
                if (draggingEl) draggingEl.classList.remove('dragging');
            });
            
            // --- EVENT DELEGATION FOR DRAG HANDLE ---
            // Listen for drag start on the entire canvas, but only act if it's from a drag handle
            canvasContent.addEventListener('dragstart', e => {
                const handle = e.target.closest('.drag-handle');
                if (handle) {
                    const component = handle.closest('.dropped-component');
                    // Add a class to the component being dragged
                    component.classList.add('dragging');
                    // Set data to identify the component being moved
                    e.dataTransfer.setData('text/component-id', component.id);

                    // Create and show the placeholder
                    const placeholder = document.createElement('div');
                    placeholder.className = 'drop-placeholder';
                    document.body.appendChild(placeholder); // Append to body to avoid flicker
                }
            });


            // --- COMPONENT MANAGEMENT ---
            function addComponentToCanvas(type, data = null) {
                const id = `comp-${componentCounter++}`;
                const template = componentTemplates[type];
                const initialProps = data ? data.properties : JSON.parse(JSON.stringify(template.properties));
                const componentData = { id, type, properties: initialProps };
                websiteComponents.push(componentData);

                const wrapper = document.createElement('div');
                wrapper.className = 'dropped-component';
                wrapper.id = id;
                wrapper.dataset.type = type;

                const controls = document.createElement('div');
                controls.className = 'component-controls';
                // The draggable="true" attribute is correctly placed on the button itself
                controls.innerHTML = `
                    <button class="control-btn drag-handle" draggable="true" title="Move">
                        <span class="material-icons" style="font-size: 18px;">drag_indicator</span>
                    </button>
                    <button class="control-btn delete-btn" title="Delete">
                        <span class="material-icons" style="font-size: 18px;">delete</span>
                    </button>
                `;
                wrapper.appendChild(controls);

                const element = document.createElement('div');
                element.className = 'component-render';
                wrapper.appendChild(element);
                
                const dropZone = document.getElementById('dropZone');
                canvasContent.insertBefore(wrapper, dropZone);
                
                updateComponentElement(id);
                selectComponent(id);
                checkCanvasEmpty();
            }

            function updateComponentElement(id) {
                const componentData = websiteComponents.find(c => c.id === id);
                const wrapper = document.getElementById(id);
                if (!componentData || !wrapper) return;

                const renderDiv = wrapper.querySelector('.component-render');
                const template = componentTemplates[componentData.type];
                renderDiv.innerHTML = template.html(componentData.properties);

                const element = renderDiv.firstElementChild;
                const props = componentData.properties;
                let styles = {};
                wrapper.style.display = '';
                wrapper.style.justifyContent = '';

                switch (componentData.type) {
                    case 'button':
                        element.textContent = props.text.value;
                        element.className = 'm3-button';
                        element.classList.add(props.style.value);
                        styles = { backgroundColor: props.style.value === 'filled' ? props.backgroundColor.value : 'transparent', color: props.style.value !== 'filled' ? props.backgroundColor.value : props.textColor.value, borderColor: props.style.value === 'outlined' ? props.backgroundColor.value : 'transparent', borderRadius: `${props.borderRadius.value}px`, fontSize: `${props.fontSize.value}px`, fontWeight: props.fontWeight.value, padding: props.padding.value };
                        wrapper.style.display = 'flex';
                        wrapper.style.justifyContent = props.alignment.value;
                        break;
                    case 'fab':
                        element.querySelector('.material-icons').textContent = props.icon.value;
                        styles = { backgroundColor: props.backgroundColor.value, color: props.iconColor.value, width: `${props.size.value}px`, height: `${props.size.value}px`, borderRadius: `${props.borderRadius.value}px`, boxShadow: props.elevation.value };
                        break;
                    case 'textfield':
                        element.placeholder = props.placeholder.value;
                        element.type = props.inputType.value;
                        styles = { width: props.width.value, fontSize: `${props.fontSize.value}px`, borderColor: props.borderColor.value, backgroundColor: props.backgroundColor.value, color: props.textColor.value };
                        break;
                    case 'chip':
                        element.textContent = props.text.value;
                        styles = { backgroundColor: props.backgroundColor.value, color: props.textColor.value, borderRadius: `${props.borderRadius.value}px`, fontSize: `${props.fontSize.value}px` };
                        break;
                    case 'card':
                        element.querySelector('h3').textContent = props.title.value;
                        element.querySelector('p').innerHTML = props.content.value.replace(/\n/g, '<br>');
                        styles = { width: props.width.value, backgroundColor: props.backgroundColor.value, boxShadow: props.elevation.value, borderRadius: `${props.borderRadius.value}px`, padding: `${props.padding.value}px` };
                        element.querySelector('h3').style.color = props.titleColor.value;
                        element.querySelector('p').style.color = props.contentColor.value;
                        break;
                    case 'text':
                        element.innerHTML = props.content.value;
                        styles = { fontSize: `${props.fontSize.value}px`, color: props.textColor.value, fontWeight: props.fontWeight.value, textAlign: props.textAlign.value, lineHeight: props.lineHeight.value };
                        break;
                    case 'image':
                        element.src = props.src.value;
                        element.alt = props.alt.value;
                        styles = { width: props.width.value, height: props.height.value, borderRadius: `${props.borderRadius.value}px`, objectFit: props.objectFit.value };
                        wrapper.style.display = 'flex';
                        wrapper.style.justifyContent = props.alignment.value;
                        break;
                    case 'divider':
                        styles = { border: 'none', height: `${props.thickness.value}px`, backgroundColor: props.color.value, margin: `${props.margin.value}px 0`, width: props.width.value };
                        break;
                    case 'appbar':
                        element.querySelector('h1').textContent = props.title.value;
                        styles = { backgroundColor: props.backgroundColor.value, color: props.textColor.value, height: `${props.height.value}px`, boxShadow: props.elevation.value };
                        element.querySelector('h1').style.fontSize = `${props.fontSize.value}px`;
                        break;
                    case 'navigation':
                        styles = { backgroundColor: props.backgroundColor.value, width: `${props.width.value}px`, };
                        element.querySelectorAll('.nav-item span').forEach(item => { item.style.color = props.iconColor.value; });
                        element.querySelectorAll('.nav-item').forEach(item => {
                            item.onmouseover = () => item.style.backgroundColor = props.activeColor.value + '20';
                            item.onmouseout = () => item.style.backgroundColor = 'transparent';
                        });
                        break;
                }
                Object.assign(element.style, styles);
            }
            
            function deleteComponent(id) {
                const index = websiteComponents.findIndex(c => c.id === id);
                if (index > -1) { websiteComponents.splice(index, 1); }
                document.getElementById(id)?.remove();
                if (id === selectedComponentId) {
                    clearPropertiesPanel();
                    selectedComponentId = null;
                }
                checkCanvasEmpty();
            }

            function selectComponent(id) {
                if (selectedComponentId) { document.getElementById(selectedComponentId)?.classList.remove('selected'); }
                selectedComponentId = id;
                document.getElementById(id).classList.add('selected');
                renderPropertiesPanel(id);
            }

            function renderPropertiesPanel(id) {
                const componentData = websiteComponents.find(c => c.id === id);
                if (!componentData) { clearPropertiesPanel(); return; }
                propertiesContent.innerHTML = '';
                const props = componentData.properties;
                for (const key in props) {
                    const prop = props[key];
                    const group = document.createElement('div'); group.className = 'property-group';
                    const label = document.createElement('label'); label.className = 'property-label'; label.textContent = prop.label; group.appendChild(label);
                    let input;
                    switch (prop.type) {
                        case 'text': input = document.createElement('input'); input.type = 'text'; input.className = 'property-input'; input.value = prop.value; input.oninput = (e) => updateProperty(id, key, e.target.value); break;
                        case 'textarea': input = document.createElement('textarea'); input.className = 'property-textarea'; input.value = prop.value; input.oninput = (e) => updateProperty(id, key, e.target.value); break;
                        case 'select':
                            input = document.createElement('select'); input.className = 'property-select';
                            const options = Array.isArray(prop.options) ? prop.options : Object.keys(prop.options);
                            options.forEach(opt => { const optionEl = document.createElement('option'); const value = Array.isArray(prop.options) ? opt : prop.options[opt]; optionEl.value = value; optionEl.textContent = opt; if (value == prop.value) optionEl.selected = true; input.appendChild(optionEl); });
                            input.onchange = (e) => updateProperty(id, key, e.target.value); break;
                        case 'color': input = document.createElement('input'); input.type = 'color'; input.className = 'property-color'; input.value = prop.value; input.oninput = (e) => updateProperty(id, key, e.target.value); break;
                        case 'range':
                            group.innerHTML += `<input type="range" class="property-range" min="${prop.min}" max="${prop.max}" value="${prop.value}"><div class="range-display">${prop.value}${prop.unit || ''}</div>`;
                            input = group.querySelector('.property-range');
                            input.oninput = (e) => { group.querySelector('.range-display').textContent = `${e.target.value}${prop.unit || ''}`; updateProperty(id, key, e.target.value); }; break;
                    }
                    if (input) group.appendChild(input);
                    propertiesContent.appendChild(group);
                }
            }
            
            function updateProperty(id, key, value) {
                const componentData = websiteComponents.find(c => c.id === id);
                if (componentData) {
                    componentData.properties[key].value = value;
                    updateComponentElement(id);
                }
            }

            function clearPropertiesPanel() {
                propertiesContent.innerHTML = `<p style="color: #666; text-align: center; margin-top: 40px;">Select a component to edit its properties</p>`;
            }

            function checkCanvasEmpty() {
                if (websiteComponents.length === 0) { canvasContent.classList.add('is-empty'); } else { canvasContent.classList.remove('is-empty'); }
            }

            // --- UI EVENT LISTENERS ---
            canvas.addEventListener('click', e => {
                const clickedComponent = e.target.closest('.dropped-component');
                if (e.target.closest('.delete-btn')) { deleteComponent(clickedComponent.id); return; }
                if (clickedComponent) { selectComponent(clickedComponent.id); } 
                else if (!e.target.closest('.properties-panel')) {
                    if (selectedComponentId) { document.getElementById(selectedComponentId)?.classList.remove('selected'); selectedComponentId = null; clearPropertiesPanel(); }
                }
            });

            document.getElementById('clearBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear the entire canvas?')) {
                    websiteComponents = [];
                    // Remove all component elements but keep the dropzone
                    const componentsToRemove = canvasContent.querySelectorAll('.dropped-component');
                    componentsToRemove.forEach(c => c.remove());
                    checkCanvasEmpty();
                    clearPropertiesPanel();
                }
            });
            
            document.getElementById('previewBtn').addEventListener('click', () => {
                const previewHtml = generateExportHtml(true);
                const previewWindow = window.open('', '_blank');
                previewWindow.document.write(previewHtml);
                previewWindow.document.close();
            });
            
            document.getElementById('exportBtn').addEventListener('click', () => {
                document.getElementById('exportedCode').value = generateExportHtml(false);
                exportModal.style.display = 'flex';
            });
            
            document.getElementById('saveBtn').addEventListener('click', () => {
                updateDataArrayOrder();
                localStorage.setItem('m3BuilderSave', JSON.stringify(websiteComponents));
                alert('Layout saved to your browser\'s local storage!');
            });
            
            document.getElementById('loadBtn').addEventListener('click', () => {
                const savedData = localStorage.getItem('m3BuilderSave');
                if (savedData) {
                    if (confirm('This will replace your current layout. Are you sure?')) {
                        // Clear current canvas
                        const componentsToRemove = canvasContent.querySelectorAll('.dropped-component');
                        componentsToRemove.forEach(c => c.remove());
                        websiteComponents = [];

                        const loadedComponents = JSON.parse(savedData);
                        loadedComponents.forEach(compData => { addComponentToCanvas(compData.type, compData); });
                        checkCanvasEmpty();
                        clearPropertiesPanel();
                    }
                } else { alert('No saved layout found.'); }
            });

            document.getElementById('closeExportBtn').addEventListener('click', () => exportModal.style.display = 'none');
            document.getElementById('copyCodeBtn').addEventListener('click', () => {
                const code = document.getElementById('exportedCode');
                code.select();
                navigator.clipboard.writeText(code.value).then(() => { alert('Code copied to clipboard!'); });
            });
            
            // --- HELPER FUNCTIONS ---
            function generateExportHtml(forPreview) {
                updateDataArrayOrder(); // Ensure data array matches DOM before export
                let bodyContent = '';
                websiteComponents.forEach(comp => {
                    const wrapperOnCanvas = document.getElementById(comp.id);
                    if (!wrapperOnCanvas) return;
                    const renderedElement = wrapperOnCanvas.querySelector('.component-render').firstElementChild;
                    if (!renderedElement) return;
                    let finalHtml = renderedElement.outerHTML;
                    const alignment = comp.properties.alignment?.value;
                    if (alignment && alignment !== 'flex-start') {
                        finalHtml = `<div style="display: flex; justify-content: ${alignment};">${finalHtml}</div>`;
                    }
                    bodyContent += finalHtml + '\n\n';
                });
                if (!forPreview) { return bodyContent.replace(/(\n\n\n)/g, '\n\n').trim(); }
                return `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Preview</title><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><style>body { font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; } * { box-sizing: border-box; } .m3-button { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; transition: all 0.2s ease; } .m3-fab { display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; } .m3-card { margin: 16px 0; } .m3-card h3 { margin-top: 0; } .m3-top-app-bar { display: flex; align-items: center; } .m3-navigation-rail { display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 12px 0; } .nav-item { display:flex; align-items:center; justify-content:center; }</style></head><body>${bodyContent}</body></html>`;
            }

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.dropped-component:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            function updateDataArrayOrder() {
                const orderedIds = [...canvasContent.querySelectorAll('.dropped-component')].map(el => el.id);
                websiteComponents.sort((a, b) => orderedIds.indexOf(a.id) - orderedIds.indexOf(b.id));
            }

            // Initial state check
            checkCanvasEmpty();
        });
    </script>
</body>
</html>
