<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Excel Editor</title>
<style>
    :root {
        --bg-color: #f4f4f4;
        --primary-text-color: #212529;
        --secondary-bg-color: #fff;
        --border-color: #ccc;
        --toolbar-bg: #f8f9fa;
        --header-bg: #f2f2f2;
        --selected-bg: #d3e3fd;
        --selected-border: #0b57d0;
        --icon-color: #495057;
    }
    body.dark-mode {
        --bg-color: #212529;
        --primary-text-color: #f8f9fa;
        --secondary-bg-color: #343a40;
        --border-color: #6c757d;
        --toolbar-bg: #495057;
        --header-bg: #495057;
        --selected-bg: #0b57d0;
        --selected-border: #6ea8fe;
        --icon-color: #f8f9fa;
    }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: var(--bg-color);
        color: var(--primary-text-color);
        transition: background-color 0.3s, color 0.3s;
    }
    .main-container {
        display: flex; flex-direction: column; padding: 20px; flex-grow: 1; min-height: 0;
    }
    .toolbar {
        padding: 10px; background-color: var(--toolbar-bg); border-bottom: 1px solid var(--border-color);
        flex-shrink: 0; display: flex; align-items: center;
    }
    .toolbar button {
        margin: 0 5px; padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border-color);
        background-color: var(--secondary-bg-color); color: var(--primary-text-color); cursor: pointer;
        transition: background-color 0.2s;
    }
    .toolbar button:hover { background-color: var(--header-bg); }
    #settings-btn {
        margin-left: auto; width: 40px; height: 38px; display: inline-flex;
        align-items: center; justify-content: center; padding: 0;
    }
    .icon {
        width: 20px; height: 20px;
        stroke: var(--icon-color);
    }

    #resizable-container {
        resize: both; overflow: hidden; border: 2px dashed var(--border-color);
        min-width: 300px; min-height: 200px; width: 100%; height: 100%; display: flex;
    }
    #spreadsheet-container {
        width: 100%; height: 100%; overflow: auto; border: 1px solid var(--border-color); border-radius: 4px;
    }
    table { border-collapse: collapse; table-layout: fixed; }
    th, td {
        border: 1px solid var(--border-color); padding: 8px; min-width: 100px; height: 25px;
        box-sizing: border-box; outline: none; text-align: left; white-space: nowrap; user-select: none;
        background-color: var(--secondary-bg-color); color: var(--primary-text-color);
    }
    th { background-color: var(--header-bg); font-weight: bold; text-align: center; position: sticky; top: 0; left: 0; z-index: 2; }
    th:first-child { z-index: 3; }
    tbody th { position: sticky; left: 0; z-index: 1; }
    td.selected { border: 2px solid var(--selected-border); background-color: var(--selected-bg); }
    td:focus { border: 2px solid var(--selected-border); background-color: var(--secondary-bg-color); user-select: text; }
    
    /* --- MODAL STYLES (FIXED) --- */
    .modal {
        display: none; /* Initially hidden */
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5);
        /* Use Flexbox to center the modal content */
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background-color: var(--bg-color);
        color: var(--primary-text-color);
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        position: relative;
        animation: fadeIn 0.3s;
        /* THE FIX: Set a max-height and enable internal scrolling */
        max-height: 85vh;
        overflow-y: auto;
    }
    @keyframes fadeIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }
    .modal-close {
        position: absolute; top: 10px; right: 10px; cursor: pointer;
        width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
    }
    .modal-close .icon { width: 24px; height: 24px; }
    .modal-close:hover .icon { stroke: var(--selected-border); }

    .modal h2 { margin-top: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .instruction-columns { display: flex; flex-wrap: wrap; gap: 20px; }
    .instruction-columns > div { flex: 1; min-width: 250px; }
    .instructions ul { list-style-type: none; padding-left: 0; font-size: 0.9em; }
    .instructions li { margin-bottom: 10px; line-height: 1.4; }
    kbd { background-color: var(--header-bg); border: 1px solid var(--border-color); color: var(--primary-text-color); border-radius: 3px; padding: 2px 5px; font-family: monospace; font-size: 0.9em; }

    .setting-item { display: flex; align-items: center; justify-content: space-between; margin: 15px 0;}
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--selected-border); }
    input:checked + .slider:before { transform: translateX(26px); }
</style>
</head>
<body>

<div class="toolbar">
    <button id="clear-all">Clear All</button>
    <button id="add-row">Add Row</button>
    <button id="add-col">Add Column</button>
    <button id="download-excel">Download .csv</button>
    <button id="download-txt">Download .txt</button>
    <button id="download-word">Download .doc</button>
    <button id="settings-btn" title="Settings">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.03.26 1.431l-1.296 2.247a1.125 1.125 0 01-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 01-.22.127c-.332.183-.582.495-.645.87l-.213 1.281c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 01-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 01-1.37-.49l-1.296-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 01-.26-1.431l1.296-2.247a1.125 1.125 0 011.37-.49l1.217.456c.355.133.75.072 1.075-.124.072-.044.146-.087.22-.127.332-.183.582-.495.645-.87l.213-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
    </button>
</div>

<div class="main-container">
    <div id="resizable-container">
        <div id="spreadsheet-container">
            <table id="spreadsheet">
                <thead><tr id="header-row"></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </span>
        <h2>Settings</h2>
        <div class="setting-item">
            <label for="dark-mode-toggle">Dark Mode</label>
            <label class="switch"><input type="checkbox" id="dark-mode-toggle"><span class="slider"></span></label>
        </div>
        <div class="instructions">
            <h2>How to Use</h2>
            <div class="instruction-columns">
                <div><h4>Basic Operations</h4><ul><li><strong>Select Cells:</strong> Click and drag your mouse.</li><li><strong>Add Row/Column:</strong> Use toolbar buttons.</li><li><strong>Clear Sheet:</strong> Use "Clear All" button.</li><li><strong>Resize Canvas:</strong> Drag the bottom-right corner.</li></ul></div>
                <div><h4>Editing & Formulas</h4><ul><li><strong>Edit Cell:</strong> Double-click a cell.</li><li><strong>Confirm Edit:</strong> Press <kbd>Enter</kbd>.</li><li><strong>Cancel Edit:</strong> Press <kbd>Escape</kbd>.</li><li><strong>Enter Formula:</strong> Start with <code>=</code>. Ex: <code>=SUM(A1:A5)</code></li></ul></div>
                <div><h4>Shortcuts & Data</h4><ul><li><strong>Copy:</strong> <kbd>Ctrl</kbd> + <kbd>C</kbd> (or <kbd>Cmd</kbd>)</li><li><strong>Paste:</strong> <kbd>Ctrl</kbd> + <kbd>V</kbd> (or <kbd>Cmd</kbd>)</li><li><strong>Undo:</strong> <kbd>Ctrl</kbd> + <kbd>Z</kbd> (or <kbd>Cmd</kbd>)</li><li><strong>Redo:</strong> <kbd>Ctrl</kbd> + <kbd>Y</kbd> (or <kbd>Cmd</kbd>)</li></ul></div>
            </div>
        </div>
    </div>
</div>

<script>
    const tableBody = document.getElementById("table-body"), headerRow = document.getElementById("header-row"), settingsModal = document.getElementById("settings-modal"), settingsBtn = document.getElementById("settings-btn"), closeModalBtn = document.querySelector(".modal-close"), darkModeToggle = document.getElementById("dark-mode-toggle");
    let numRows = 50, numCols = 20, historyStack = [], historyIndex = -1, isSelecting = !1, startCell = null, endCell = null;

    // --- SETTINGS & THEME LOGIC (FIXED) ---
    // THE FIX: Change display to 'flex' to enable centering
    settingsBtn.onclick = () => settingsModal.style.display = 'flex';
    closeModalBtn.onclick = () => settingsModal.style.display = 'none';
    window.onclick = (e) => { if (e.target == settingsModal) settingsModal.style.display = 'none'; };

    darkModeToggle.addEventListener('change', (e) => {
        document.body.classList.toggle('dark-mode', e.target.checked);
        localStorage.setItem('darkMode', e.target.checked);
    });

    function loadPreferences() {
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        darkModeToggle.checked = isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
    }
    
    // --- All other JavaScript logic from the previous version remains the same ---
    function undo(){historyIndex>0&&(historyIndex--,restoreState(historyStack[historyIndex]))}
    function redo(){historyIndex<historyStack.length-1&&(historyIndex++,restoreState(historyStack[historyIndex]))}
    document.getElementById("clear-all").addEventListener("click",()=>{confirm("Are you sure you want to clear the entire sheet?")&&(createGrid(),historyStack=[],historyIndex=-1,saveState())}),document.getElementById("add-row").addEventListener("click",()=>{numRows++,createGrid(),saveState()}),document.getElementById("add-col").addEventListener("click",()=>{numCols++,createGrid(),saveState()});
    document.getElementById("download-excel").addEventListener("click",()=>{downloadFile(generateCSV(),"spreadsheet.csv","text/csv;charset=utf-8;")}),document.getElementById("download-txt").addEventListener("click",()=>{const e=generateCSV().replace(/,/g,"\t");downloadFile(e,"spreadsheet.txt","text/plain;charset=utf-8;")}),document.getElementById("download-word").addEventListener("click",()=>{const e=document.getElementById("spreadsheet").outerHTML,t=`<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export</title></head><body>${e}</body></html>`;downloadFile(t,"spreadsheet.doc","application/msword")});
    tableBody.addEventListener("dblclick",e=>{"TD"===e.target.tagName&&makeCellEditable(e.target)}),tableBody.addEventListener("mousedown",e=>{"TD"===e.target.tagName&&(isSelecting=!0,startCell=e.target,endCell=e.target,clearSelection(),e.target.classList.add("selected"))}),tableBody.addEventListener("mouseover",e=>{isSelecting&&"TD"===e.target.tagName&&(endCell=e.target,selectRange(startCell,endCell))}),window.addEventListener("mouseup",()=>{isSelecting=!1}),tableBody.addEventListener("blur",e=>{e.target.hasAttribute("contenteditable")&&processCellInput(e.target)},!0),document.addEventListener("keydown",e=>{if(e.ctrlKey||e.metaKey)e.key.toLowerCase()==="z"&&(e.preventDefault(),undo()),e.key.toLowerCase()==="y"&&(e.preventDefault(),redo());else if(e.target.hasAttribute("contenteditable")){if("Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),processCellInput(e.target)),"Escape"===e.key){e.target.dataset.formula&&(e.target.textContent=e.target.dataset.formula),e.target.removeAttribute("contenteditable"),e.target.blur()}}}),document.addEventListener("paste",e=>{e.preventDefault();const t=document.querySelector(".selected");if(!t)return;const o=parseInt(t.dataset.row),s=parseInt(t.dataset.col);navigator.clipboard.readText().then(e=>{const t=e.includes("\t")?"\t":",";e.trim().split("\n").forEach((e,r)=>{e.split(t).forEach((e,l)=>{const n=o+r,c=s+l;if(n<numRows&&c<numCols){const t=document.getElementById(getIdFromCoords(n,c));delete t.dataset.formula;const o=e.trim();o.startsWith("=")?t.dataset.formula=o:t.textContent=o}})}),evaluateSheet(),saveState()})});
    function getCoordsFromId(e){const t=e.match(/[A-Z]+/)[0],o=e.match(/\d+/)[0];return{row:parseInt(o)-1,col:t.charCodeAt(0)-65}}
    function getIdFromCoords(e,t){return`${String.fromCharCode(65+t)}${e+1}`}
    function parseCellValue(e){return parseFloat(e.replace(",","."))}
    function createGrid(){headerRow.innerHTML="",tableBody.innerHTML="";const e=document.createElement("th");headerRow.appendChild(e);for(let t=0;t<numCols;t++){const e=document.createElement("th");e.textContent=String.fromCharCode(65+t),headerRow.appendChild(e)}for(let t=0;t<numRows;t++){const e=document.createElement("tr"),o=document.createElement("th");o.textContent=t+1,e.appendChild(o);for(let s=0;s<numCols;s++){const o=document.createElement("td");o.id=`${String.fromCharCode(65+s)}${t+1}`,o.dataset.row=t,o.dataset.col=s,e.appendChild(o)}tableBody.appendChild(e)}}
    function saveState(){const e=[];tableBody.querySelectorAll("td").forEach(t=>{t.textContent||t.dataset.formula?e.push({id:t.id,text:t.textContent,formula:t.dataset.formula}):void 0}),historyIndex<historyStack.length-1&&(historyStack=historyStack.slice(0,historyIndex+1)),historyStack.push(e),historyIndex++}
    function restoreState(e){tableBody.querySelectorAll("td").forEach(e=>{e.textContent="",delete e.dataset.formula}),e&&e.forEach(e=>{const t=document.getElementById(e.id);t&&(t.textContent=e.text||"",e.formula?t.dataset.formula=e.formula:delete t.dataset.formula)}),evaluateSheet()}
    function generateCSV(){let e="";for(let t=0;t<numRows;t++){let o=[];for(let s=0;s<numCols;s++){const r=document.getElementById(getIdFromCoords(t,s));let l=r.dataset.formula||r.textContent||"";l.includes(",")||l.includes('"')||l.includes("\n")?l=`"${l.replace(/"/g,'""')}"`:void 0,o.push(l)}e+=o.join(",")+"\r\n"}return e}
    function downloadFile(e,t,o){const s=new Blob([e],{type:o}),r=document.createElement("a");r.href=URL.createObjectURL(s),r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(r.href)}
    function makeCellEditable(e){e.setAttribute("contenteditable","true"),e.focus(),e.dataset.formula&&(e.textContent=e.dataset.formula)}
    function processCellInput(e){e.removeAttribute("contenteditable");const t=e.textContent.trim();delete e.dataset.formula,t.startsWith("=")&&(e.dataset.formula=t),evaluateSheet(),saveState()}
    function evaluateSheet(){tableBody.querySelectorAll("td[data-formula]").forEach(e=>{try{const t=e.dataset.formula.substring(1).toUpperCase();if(t.startsWith("SUM(")&&t.endsWith(")")){const o=t.substring(4,t.length-1).split(":"),s=o[0],r=o[1],l=getCoordsFromId(s),n=getCoordsFromId(r);let c=0;for(let t=Math.min(l.row,n.row);t<=Math.max(l.row,n.row);t++)for(let o=Math.min(l.col,n.col);o<=Math.max(l.col,n.col);o++){const s=document.getElementById(getIdFromCoords(t,o));if(s&&""!==s.textContent){const t=parseCellValue(s.textContent);isNaN(t)||(c+=t)}}e.textContent=c}else e.textContent="#NAME?"}catch(e){textContent="#ERROR!"}})}
    function clearSelection(){document.querySelectorAll(".selected").forEach(e=>e.classList.remove("selected"))}
    function selectRange(e,t){clearSelection();const o=Math.min(e.dataset.row,t.dataset.row),s=Math.max(e.dataset.row,t.dataset.row),r=Math.min(e.dataset.col,t.dataset.col),l=Math.max(e.dataset.col,t.dataset.col);for(let e=o;e<=s;e++)for(let t=r;t<=l;t++){const o=tableBody.rows[e]?.cells[t+1];o&&o.classList.add("selected")}}
    loadPreferences();createGrid();saveState();
</script>
</body>
</html>```
